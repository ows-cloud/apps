<?xml version="1.0" encoding="utf-8" ?>
<odoo>
    <!--
        Lønnsregler som trenger sum:
        - Tabelltrekk
        - Prosenttrekk
        - Netto utbetalt (sum av kategoriser)
        - Feriepengegrunnlag
        - Arbeidsgiveravgiftsgrunnlag
        Fortsett å bruke categories.CODE
        Ellers må ma lage en funksjon som summerer linjer som oppfyller kriteriene.
        payslip.line_ids.filtered(lambda l: l.l10n_no_BeregnTrekk == 'tabelltrekk')
    -->
    <record id="rule_fixed_salary" model="hr.salary.rule">
        <field name="name">Fastlønn</field>
        <field name="sequence" eval="1" />
        <field name="code">LOENN</field>
        <field name="category_id" ref="payroll.BASIC" />
        <field name="amount_select">fix</field>
        <field name="amount_fix">30000</field>
        <field name="l10n_no_RegelType">loennsinntekt</field>
        <field name="l10n_no_Fordel">kontantytelse</field>
        <field name="l10n_no_Loennsbeskrivelse">fastloenn</field>
        <field name="l10n_no_BeregnAga">loennOgGodtgjoerelse</field>
        <field name="l10n_no_BeregnTrekk">tabelltrekk</field>
    </record>
    <record id="rule_fp_i_aar" model="hr.salary.rule">
        <field name="name">Feriepenger i år</field>
        <field name="sequence" eval="100" />
        <field name="code">FP_I_AAR</field>
        <field name="category_id" ref="payroll.BASIC" />
        <field name="amount_select">fix</field>
        <field name="amount_fix">1000</field>
        <field name="l10n_no_RegelType">loennsinntekt</field>
        <field name="l10n_no_Fordel">kontantytelse</field>
        <field name="l10n_no_Loennsbeskrivelse">feriepenger</field>
        <field name="l10n_no_BeregnAga">loennOgGodtgjoerelse</field>
        <field name="l10n_no_BeregnTrekk">prosenttrekk</field>
    </record>
    <record id="rule_fp_i_fjor" model="hr.salary.rule">
        <field name="name">Feriepenger i fjor</field>
        <field name="sequence" eval="100" />
        <field name="code">FP_I_FJOR</field>
        <field name="category_id" ref="payroll.BASIC" />
        <field name="amount_select">fix</field>
        <field name="amount_fix">2000</field>
        <field name="l10n_no_RegelType">loennsinntekt</field>
        <field name="l10n_no_Fordel">kontantytelse</field>
        <field name="l10n_no_Loennsbeskrivelse">feriepenger</field>
        <field name="l10n_no_BeregnAga">loennOgGodtgjoerelse</field>
    </record>
    <record id="rule_km_skattefritt" model="hr.salary.rule">
        <field name="name">Km-godtgjørelse (utgiftsgodtgjørelse)</field>
        <field name="sequence" eval="100" />
        <field name="code">KM</field>
        <field name="category_id" ref="payroll.BASIC" />
        <field name="amount_select">code</field>
        <field name="amount_python_compute">
result = 3.50
result_qty = 100
        </field>
        <field name="l10n_no_RegelType">loennsinntekt</field>
        <field name="l10n_no_Fordel">utgiftsgodtgjoerelse</field>
        <field name="l10n_no_Loennsbeskrivelse">kilometergodtgjoerelseBil</field>
    </record>
    <record id="rule_km_skattepliktig" model="hr.salary.rule">
        <field name="name">Km-godtgjørelse (naturallønn)</field>
        <field name="sequence" eval="100" />
        <field name="code">KM-SKATT</field>
        <field name="category_id" ref="payroll.BASIC" />
        <field name="amount_select">code</field>
        <field name="amount_python_compute">
result = 1.00
result_qty = 100
        </field>
        <field name="l10n_no_RegelType">loennsinntekt</field>
        <field name="l10n_no_Fordel">kontantytelse</field>
        <field name="l10n_no_Loennsbeskrivelse">kilometergodtgjoerelseBil</field>
        <field name="l10n_no_BeregnAga">fradragIGrunnlagetForSone</field>
        <field name="l10n_no_BeregnTrekk">tabelltrekk</field>
    </record>


    <record id="rule_tabelltrekk" model="hr.salary.rule">
        <field name="code">tabelltrekk</field>
        <field name="name">Forskuddstrekk (tabell)</field>
        <field name="category_id" ref="payroll.DED" />
        <field name="sequence" eval="198" />
        <field name="condition_select">python</field>
        <field name="condition_python">
result = payslip.line_sum_where("l10n_no_BeregnTrekk", "tabelltrekk", rules, result_rules)
        </field>
        <field name="amount_select">code</field>
        <field name="amount_python_compute">
year = payslip.date_from.year

andel_av_trekk = 0.5 if payslip.date_from.month == 12 else 1.0

trekkgrunnlag = payslip.line_sum_where("l10n_no_BeregnTrekk", "tabelltrekk", rules, result_rules)

trekktabell = employee.l10n_no_trekktabell
if trekktabell:
    result = employee.l10n_no_get_tax_deduction(
        year=year,
        andel_av_trekk=andel_av_trekk,
        trekkgrunnlag=trekkgrunnlag // 100 * 100,
        trekkperiode='1', # måned
        tabelltype='0',   # lønn
    )
    result_name = "Skattetrekk av {g:.2f} kr (tabell {t})".format(g=trekkgrunnlag, t=trekktabell)
else:
    prosent = employee.l10n_no_trekkprosent
    result = -int(trekkgrunnlag * prosent / 100.0 * andel_av_trekk)
    result_name = "Skattetrekk av {g:.2f} kr ({p} %)".format(g=trekkgrunnlag, p=prosent)
        </field>
    </record>
    <record id="rule_prosenttrekk" model="hr.salary.rule">
        <field name="code">prosenttrekk</field>
        <field name="name">Forskuddstrekk (prosent)</field>
        <field name="category_id" ref="payroll.DED" />
        <field name="sequence" eval="199" />
        <field name="condition_select">python</field>
        <field name="condition_python">
result = payslip.line_sum_where("l10n_no_BeregnTrekk", "prosenttrekk", rules, result_rules)
        </field>
        <field name="amount_select">code</field>
        <field name="amount_python_compute">
andel_av_trekk = 0.5 if payslip.date_from.month == 12 else 1.0

trekkgrunnlag = payslip.line_sum_where("l10n_no_BeregnTrekk", "prosenttrekk", rules, result_rules)

prosent = employee.l10n_no_trekkprosent

result = round( -trekkgrunnlag * prosent / 100.0 * andel_av_trekk )

result_name = "Skattetrekk av {g:.2f} kr ({p} %)".format(g=trekkgrunnlag, p=prosent)
        </field>
    </record>
    <record id="rule_utbetaling" model="hr.salary.rule">
        <field name="name">Netto utbetaling</field>
        <field name="sequence" eval="200" />
        <field name="code">NET</field>
        <!-- <field name="category_id" ref="" /> -->
        <field name="amount_select">code</field>
        <field name="amount_python_compute">
result = categories.BASIC + categories.DED
        </field>
        <field name="l10n_no_RegelType">loennsinntekt</field>
        <field name="l10n_no_Fordel">naturalytelse</field>
        <field name="l10n_no_Loennsbeskrivelse">annet</field>
        <field name="l10n_no_BeregnAga">tilskuddOgPremieTilPensjon</field>
    </record>
    <record id="rule_pensjon" model="hr.salary.rule">
        <field name="name">Pensjon</field>
        <field name="sequence" eval="201" />
        <field name="code">PENSJON</field>
        <!-- <field name="category_id" ref="" /> -->
        <field name="amount_select">fix</field>
        <field name="amount_fix">1000</field>
        <field name="l10n_no_RegelType">loennsinntekt</field>
        <field name="l10n_no_Fordel">naturalytelse</field>
        <field name="l10n_no_Loennsbeskrivelse">annet</field>
        <field name="l10n_no_BeregnAga">tilskuddOgPremieTilPensjon</field>
    </record>
</odoo>
